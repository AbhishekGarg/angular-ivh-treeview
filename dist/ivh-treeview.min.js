angular.module("ivh.treeview",[]),angular.module("ivh.treeview").directive("ivhTreeviewCheckbox",[function(){"use strict";return{restrict:"A",scope:{node:"=ivhTreeviewCheckbox"},require:"^ivhTreeview",link:function(a,b,c,d){var e=a.node,f=d.opts(),g=f.indeterminateAttribute,h=f.selectedAttribute;a.isSelected=e[h],a.ctrl=d,a.$watch(function(){return e[h]},function(b){a.isSelected=b}),a.$watch(function(){return e[g]},function(a){b.find("input").prop("indeterminate",a)})},template:['<input type="checkbox"','ng-model="isSelected"','ng-change="ctrl.select(node, isSelected)" />'].join("\n")}}]),angular.module("ivh.treeview").directive("ivhTreeviewNode",["ivhTreeviewCompiler",function(a){"use strict";return{restrict:"A",scope:{node:"=ivhTreeviewNode",depth:"=ivhTreeviewDepth"},require:"^ivhTreeview",compile:function(b){return a.compile(b,function(a,b,c,d){a.ctrl=d,a.childDepth=a.depth+1;var e=a.node,f=a.children=d.children(e);f.length||b.addClass("ivh-treeview-node-leaf"),d.isExpanded(a.depth)||b.addClass("ivh-treeview-node-collapsed"),b.attr("title",d.label(e))})},template:["<div>","<div>",'<span ivh-treeview-toggle="node">',"(-)","</span>",'<span ng-if="ctrl.useCheckboxes()"','ivh-treeview-checkbox="node">',"</span>",'<span class="ivh-treeview-node-label">',"{{ctrl.label(node)}}","</span>","</div>",'<ul ng-if="children.length" class="ivh-treeview">','<li ng-repeat="child in children"','ng-hide="ctrl.hasFilter() && !ctrl.isVisible(child)"','ivh-treeview-node="child"','ivh-treeview-depth="childDepth">',"</li>","</ul>","</div>"].join("\n")}}]),angular.module("ivh.treeview").directive("ivhTreeviewToggle",[function(){"use strict";return{restrict:"A",require:"^ivhTreeview",scope:{node:"=ivhTreeviewToggle"},link:function(a,b,c,d){if(d.children(a.node).length){for(var e=b.parent();e&&"LI"!==e.prop("nodeName");)e=e.parent();b.bind("click",function(){e.toggleClass("ivh-treeview-node-collapsed")})}}}}]),angular.module("ivh.treeview").directive("ivhTreeview",function(){"use strict";return{restrict:"A",scope:{root:"=ivhTreeview",childrenAttribute:"=ivhTreeviewChildrenAttribute",defaultSelectedState:"=ivhTreeviewDefaultSelectedState",expandToDepth:"=ivhTreeviewExpandToDepth",idAttribute:"=ivhTreeviewIdAttribute",indeterminateAttribute:"=ivhTreeviewIndeterminateAttribute",labelAttribute:"=ivhTreeviewLabelAttribute",selectedAttribute:"=ivhTreeviewSelectedAttribute",useCheckboxes:"=ivhTreeviewUseCheckboxes",visibleAttribute:"=ivhTreeviewVisibleAttribute",filter:"=ivhTreeviewFilter"},controllerAs:"ctrl",controller:["$scope","$element","$attrs","$transclude","ivhTreeviewMgr","ivhTreeviewOptions","filterFilter",function(a,b,c,d,e,f,g){var h=angular,i=this,j=i.root=a.root,k=h.extend({},f());h.forEach(["childrenAttribute","defaultSelectedState","expandToDepth","idAttribute","indeterminateAttribute","labelAttribute","selectedAttribute","useCheckboxes","visibleAttribute"],function(b){h.isDefined(a[b])&&(k[b]=a[b])}),i.opts=function(){return k},i.children=function(a){var b=a[k.childrenAttribute];return h.isArray(b)?b:[]},i.label=function(a){return a[k.labelAttribute]},i.hasFilter=function(){return h.isDefined(a.filter)},i.getFilter=function(){return a.filter||""},i.isVisible=function(a){var b=i.getFilter();return b?!!g([a],b).length:!0},i.useCheckboxes=function(){return k.useCheckboxes},i.select=function(a,b){e.select(j,a,k,b)},i.isExpanded=function(a){var b=-1===k.expandToDepth?1/0:k.expandToDepth;return b>a}}],template:['<ul class="ivh-treeview">','<li ng-repeat="child in root | ivhTreeviewAsArray"','ng-hide="ctrl.hasFilter() && !ctrl.isVisible(child)"','ivh-treeview-node="child"','ivh-treeview-depth="0">',"</li>","</ul>"].join("\n")}}),angular.module("ivh.treeview").filter("ivhTreeviewAsArray",function(){"use strict";return function(a){return!angular.isArray(a)&&angular.isObject(a)?[a]:a}}),angular.module("ivh.treeview").factory("ivhTreeviewBfs",["ivhTreeviewOptions",function(a){"use strict";var b=angular;return function(c,d,e){2===arguments.length&&b.isFunction(d)&&(e=d,d={}),d=angular.extend({},a(),d),e=e||b.noop;var f,g,h,i,j,k=[],l=d.childrenAttribute;for(b.isArray(c)?(b.forEach(c,function(a){k.push([a,[]])}),f=k.shift()):f=[c,[]];f;){if(g=f[0],h=f[1],e(g,h)!==!1&&g[l]&&b.isArray(g[l]))for(j=g[l].length,i=0;j>i;i++)k.push([g[l][i],[g].concat(h)]);f=k.shift()}}}]),angular.module("ivh.treeview").factory("ivhTreeviewCompiler",["$compile",function(a){"use strict";return{compile:function(b,c){angular.isFunction(c)&&(c={post:c});var d,e=b.contents().remove();return{pre:c&&c.pre?c.pre:null,post:function(b,f){d||(d=a(e)),d(b,function(a){f.append(a)}),c&&c.post&&c.post.apply(null,arguments)}}}}}]),angular.module("ivh.treeview").factory("ivhTreeviewMgr",["ivhTreeviewOptions","ivhTreeviewBfs",function(a,b){"use strict";var c=angular,d=a(),e={},f=function(a){a[this.selectedAttribute]=!1,a[this.indeterminateAttribute]=!1},g=function(a){a[this.selectedAttribute]=!0,a[this.indeterminateAttribute]=!1},h=function(a){var b=a[this.childrenAttribute],d=this.selectedAttribute,e=this.indeterminateAttribute,f=0,g=0;c.forEach(b,function(a){a[d]?f++:a[e]&&g++}),0===f&&0===g?(a[d]=!1,a[e]=!1):f===b.length?(a[d]=!0,a[e]=!1):(a[d]=!1,a[e]=!0)};return e.select=function(a,i,j,k){arguments.length>2&&"boolean"==typeof j&&(k=j,j={}),j=c.extend({},d,j),k=c.isDefined(k)?k:!0;var l=angular.isString(i),m=!0,n=j.idAttribute;return b(a,j,function(a,d){var e=m&&(l?i===a[n]:i===a);if(e){m=!1;var o=k?g.bind(j):f.bind(j);b(a,j,o),c.forEach(d,h.bind(j))}return m}),e},e.selectAll=function(a,f,g){arguments.length>1&&"boolean"==typeof f&&(g=f,f={}),f=c.extend({},d,f),g=c.isDefined(g)?g:!0;var h=f.selectedAttribute,i=f.indeterminateAttribute;return b(a,f,function(a){a[h]=g,a[i]=!1}),e},e.selectEach=function(a,b,d,f){return c.forEach(b,function(b){e.select(a,b,d,f)}),e},e.deselect=function(a,b,c){return e.select(a,b,c,!1)},e.deselectAll=function(a,b){return e.selectAll(a,b,!1)},e.deselectEach=function(a,b,c){return e.selectEach(a,b,c,!1)},e.validate=function(a,f,g){arguments.length>1&&"boolean"==typeof f&&(g=f,f={}),f=c.extend({},d,f),g=c.isDefined(g)?g:f.defaultSelectedState;var h=f.selectedAttribute,i=f.indeterminateAttribute;b(a,f,function(b){return c.isDefined(b[h])&&b[h]!==g?(e.select(a,b,f,!g),!1):(b[h]=g,void(b[i]=!1))})},e}]),angular.module("ivh.treeview").provider("ivhTreeviewOptions",function(){"use strict";var a={idAttribute:"id",labelAttribute:"label",childrenAttribute:"children",selectedAttribute:"selected",expandToDepth:0,useCheckboxes:!0,indeterminateAttribute:"__ivhTreeviewIndeterminate",defaultSelectedState:!0};this.update=function(b){angular.extend(a,b)},this.$get=function(){return function(){return angular.copy(a)}}});